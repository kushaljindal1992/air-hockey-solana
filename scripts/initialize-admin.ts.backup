import * as anchor from "@coral-xyz/anchor";
import { Program } from "@coral-xyz/anchor";
import { EscrowFee } from "../target/types/escrow_fee";
import { PublicKey, SystemProgram, LAMPORTS_PER_SOL } from "@solana/web3.js";
import fs from "fs";

async function main() {
  console.log("üîê Air Hockey - Admin Wallet Setup\n");

  const provider = anchor.AnchorProvider.env();
  anchor.setProvider(provider);
  const program = anchor.workspace.EscrowFee as Program<EscrowFee>;
  const admin = provider.wallet as anchor.Wallet;
  
  console.log("Admin Wallet:", admin.publicKey.toString());
  console.log("Program ID:", program.programId.toString());
  
  const balance = await provider.connection.getBalance(admin.publicKey);
  console.log("Admin Balance:", balance / LAMPORTS_PER_SOL, "SOL");
  
  if (balance < 0.1 * LAMPORTS_PER_SOL) {
    console.error("\n‚ùå Insufficient balance! Run: solana airdrop 2");
    process.exit(1);
  }
  
  const [platformStatePDA, bump] = PublicKey.findProgramAddressSync(
    [Buffer.from("platform_state")],
    program.programId
  );
  
  console.log("\nPlatform State PDA:", platformStatePDA.toString());
  
  try {
    const platformState = await program.account.platformState.fetch(platformStatePDA);
    console.log("\n‚ö†Ô∏è  Already initialized!");
    console.log("Admin:", platformState.admin.toString());
    console.log("Fee:", platformState.feePercentage + "%");
    return;
  } catch (error) {
    console.log("\n‚úÖ Proceeding with initialization...");
  }
  
  const FEE_PERCENTAGE = 5;
  console.log("\nüèóÔ∏è  Initializing platform...");
  
  const tx = await program.methods
    .initialize(FEE_PERCENTAGE)
    .accounts({
      platformState: platformStatePDA,
      admin: admin.publicKey,
      systemProgram: SystemProgram.programId,
    })
    .rpc();
  
  console.log("\n‚úÖ Platform Initialized!");
  console.log("Transaction:", tx);
  
  await provider.connection.confirmTransaction(tx, "confirmed");
  
  const platformState = await program.account.platformState.fetch(platformStatePDA);
  console.log("\nüìä Platform State:");
  console.log("Admin:", platformState.admin.toString());
  console.log("Fee:", platformState.feePercentage + "%");
  
  const config = {
    programId: program.programId.toString(),
    platformStatePDA: platformStatePDA.toString(),
    admin: admin.publicKey.toString(),
    feePercentage: FEE_PERCENTAGE,
    cluster: provider.connection.rpcEndpoint,
    initializedAt: new Date().toISOString(),
  };
  
  fs.writeFileSync("admin-config.json", JSON.stringify(config, null, 2));
  console.log("\nüíæ Configuration saved to admin-config.json");
}

main().then(() => process.exit(0)).catch((error) => {
  console.error("\n‚ùå Error:", error);
  process.exit(1);
});
EOF